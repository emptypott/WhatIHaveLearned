# 4장 엔티티 매핑

ORM JPA 기반으로 어플리케이션 모델링시에  엔티티와 테이블을 매핑의 정확함이 필요

관련한 매핑 어노테이션 숙지 필요

JPA에서 지원하는 매핑어노테이션을 크게 4가지로 분류

- 객체와 테이블 매핑: @Entity @Table
- 기본 키 매핑: @Id
- 필드와 컬럼 매핑: @Column
- 연관관계 매핑:@ManyToOne, @JoinColum

### 4.1 @Entity

@Entity 적용시에 주의사항

- 기본 생성자는 필수(public, protected 허용)
- final 클래스, enum, interface, inner 클래스에는 사용할 수 없다.
- 저장할 필드에 final을 사용하면 안 된다.

### 4.2 @Table

### 4.3 다양한 매핑 사용

### 4.4 데이터베이스 스키마 자동 생성

JPA는 데이터베이스 스키마를 자동 생성을 지원한다. 로컬환경에서 H2데이터베이스 활용한 개발환경 구축할 때 용이하다.

매핑정보와 데이터베이스 방어늘 사용해서 데이터베이스 스키마를 생성

운영환경에서 데이터베이스 스키마 자동 생성 기능을 이용하기에는 어려우며 로컬 환경에서 적합

> 이름 매핑 전략 변경하기

단어끼리 구분할때 자바에서는 카멜케이스를 보통 사용하고 데이터베이스는 언더스코어를 사용

@Column 어노테이션을 활용하여 명시적으로 사용해 이름을 지어주어야 하는 번거로움 발생

이에 대한 해결책으로 hibernate.ejb.naming-strategy 속성 사용시 이름 매핑 전략 변경 가능하다.

ImprovedNamingStrategy 클래스를 제공

### 4.5 DDL 생성 기능

스키마 자동 생성하기를 통해 만들어지는 DDL 에 제약조건을 활용시 명시적으로 엔티티만 보고도 개발자가 파악하기 쉽다. 애플리케이션 실행에는 영향을 주지않으나 운영환경에서는 사용하기 어려움.

### 4.6 기본 키 매핑

오라클의 시퀀스 오브젝트, MySQL 의  auto_increment 같은 기능 어떻게 구현할까.?

데이터베이스 기본키 생성 전략

- 직접 할당: 기본 키를 애플리케이션에서 직접할당
- 자동 생성: 대리키 사용 방식
    - IDENTITY : 기본 키 생성을 데이터베이스에 위임
    - SEQUENCE : 데이터베이스 시퀀스를 사용해서 기본 키를 할당한다.
    - TABLE : 키 생성 테이블을 사용한다.

데이터베이스 벤더마다 지원 방식이 다르기 때문에 전략이 다양하다.

@Id 적용 가능한 자바 타입은 다음과 같음

- 자바 기본형
- 자바 래퍼형
- String
- java.util.Date
- java.sql.Date
- java.math.BigDecimal
- java.math.BigInteger

> IDENTITY 전략과 최적화

데이터를 데이터베이스에 INSERT 한 후에 기본 키 값을 조회할 수 있다. 엔티티에 식별자 값을 할당하려면 JPA는 추가로 데이터베이스를 조회해야 한다.

JDBC3 에 추가된 Statement.getGeneratedKeys() 를 사용하면 데이터를 저장과 동시에 생성된 기본 키 값도 얻어올 수 있다. 하이버네이트는 이 메소드를 사용해서 데이터베이스와 한번만 통신한다.

엔티티가 영속 상태가 되려면 식별자가 반드시 필요. 그런데 IDENTITY 식별자 생성 전략은 엔티티를 데이터베이스에 저장해야 식별자를 구할 수 있으므로 em.persist()를 호출하는 즉시 INSERT SQL 이 데이터베이스에 전달된다. 따라서 이 전략은 트랜잭션을 지원하는 쓰기 지연이 동작하지 않는다.

> SEQUENCE 전략

유일한 값을 순서대로 생성하는 오브젝트 = 시퀀스

오라클, PostgreSQL, DB2, H2 에서 사용 가능

코드는 IDENTITY 와 같지만 내부 동작 방식 다르다. em.persist() 호출시 먼저 데이터베이스 시퀀스를 사용해서 식별자를 조회 그리고 조회한 식별자를 엔티티에 할당한 후에 엔티티를 영속성 컨텍스트에 저장 이후 트랜잭션 커밋 후 플러시

- allocationSize default 50 이유 & DB와 2번 통신 how?

 

> AUTO 전략

[GenerationType.AUTO](http://generationtype.AUTO) 는 선택한 데이터베이스 방언에 따라 IDENTITY, SEQUENCE, TABLE 전략 중 하나를 자동으로 선택

권장하는 식별자 선택 전략

자연 키보다는 대리 키 권장 - 자연키의 경우 변경 가능성이 존재

기본키는 불변을 보장해야 한다는 원칙을 생각해볼것.

Enumerated

EnumType.STRING 사용 권장 - 크기 비효율이지만 변경에 용이

Temporal

날짜 타입을 매핑할 때 사용 

LocalDateTime 사용시 필요없음.

Lob

BLOB, CLOB 타입과 매핑

Transient

이 필드는 매핑하지 않는다. 객체에 임시로 어떤 값을 보관하고 싶을때 사용

Access

JPA가 엔티티 데이터에 접근하는 방식을 지정함.

- 필드 접근 : private이어도 접근할 수 있다.
- 프로퍼티 접근: Getter 사용

필드 접근 방식과 프로퍼티 접근 방식을 혼용하는 경우..?